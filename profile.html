<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>flashback – profile</title>
    <link rel="stylesheet" href="map.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Just+Me+Again+Down+Here&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <main class="main-flex">
      <aside class="sidebar scrapbook-border">
        <a
          href="index.html"
          class="flashback-cute"
          style="text-decoration: none; color: #f89090"
          >flashback</a
        >
        <nav class="sidebar-menu" style="margin-top: 1.5em; position: relative">
          <button
            type="button"
            class="sidebar-menu-item"
            onclick="window.location.href='map.html'"
          >
            Map
          </button>
          <button
            type="button"
            class="sidebar-menu-item"
            onclick="window.location.href='drop-pin.html'"
          >
            Drop a Pin
          </button>
          <button type="button" class="sidebar-menu-item active">
            Profile
          </button>
          <button
            type="button"
            class="sidebar-menu-item"
            onclick="window.location.href='settings.html'"
          >
            Settings
          </button>
        </nav>
        <div style="flex: 1"></div>
        <div
          id="sidebar-user-profile"
          style="
            display: flex;
            align-items: center;
            gap: 0.8em;
            padding: 1.2em 1.2em 2.5em 1.2em;
            margin-bottom: 1.5em;
            position: relative;
          "
        >
          <img
            id="sidebar-user-avatar"
            src="https://api.dicebear.com/7.x/personas/svg?seed=ava"
            alt="User Avatar"
            style="
              width: 44px;
              height: 44px;
              border-radius: 50%;
              border: 2.5px solid #f89090;
              background: #fff;
              object-fit: cover;
            "
          />
          <span
            id="sidebar-user-name"
            style="
              font-family: 'Just Me Again Down Here', cursive;
              font-size: 1.3em;
              color: #f89090;
              font-weight: bold;
              margin-right: 0.5em;
            "
            >User</span
          >
          <div style="position: relative; margin-left: auto">
            <button
              id="sidebar-menu-btn"
              style="
                background: none;
                border: none;
                cursor: pointer;
                font-size: 1.5em;
                color: #f89090;
                padding: 0 0.2em;
              "
            >
              &#8942;
            </button>
            <div
              id="sidebar-menu-dropdown"
              style="
                display: none;
                position: absolute;
                right: 0;
                top: 2.2em;
                background: #fff;
                border: 1.5px solid #f89090;
                border-radius: 10px;
                box-shadow: 0 2px 8px #f8909022;
                min-width: 120px;
              "
            >
              <button
                id="logout-btn"
                style="
                  display: block;
                  width: 100%;
                  background: none;
                  border: none;
                  padding: 0.7em 1.2em;
                  text-align: left;
                  color: #f89090;
                  font-family: 'Just Me Again Down Here', cursive;
                  font-size: 1.1em;
                  cursor: pointer;
                "
              >
                Log out
              </button>
            </div>
          </div>
        </div>
      </aside>
      <section
        class="profile-green-full"
        style="
          min-height: 100vh;
          max-height: 100vh;
          overflow-y: auto;
          display: flex;
          flex-direction: column;
          align-items: flex-start;
        "
      >
        <div
          style="
            margin-top: 13em;
            margin-left: 2.5em;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 1.2em;
            min-width: 340px;
            max-width: 420px;
            background: none;
            margin-bottom: 0;
            padding: 0;
          "
        >
          <div style="display: flex; align-items: center; gap: 1.2em">
            <img
              id="profile-avatar"
              src="https://api.dicebear.com/7.x/personas/svg?seed=ava"
              alt="Profile Picture"
              style="
                width: 74px;
                height: 74px;
                border-radius: 50%;
                border: 3px solid #4caf50;
                background: #fff;
                object-fit: cover;
              "
            />
            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 0.3em;
                align-items: flex-start;
              "
            >
              <span
                id="profile-name"
                style="
                  font-size: 1.3em;
                  color: #7a5c2e;
                  font-family: 'Just Me Again Down Here', cursive;
                  font-weight: bold;
                "
                >Name</span
              >
              <!-- Username removed as per new requirements -->
              <span
                id="profile-about"
                style="
                  font-size: 1.05em;
                  color: #7a5c2e;
                  font-family: 'Just Me Again Down Here', cursive;
                "
                >About you</span
              >
              <span
                id="profile-location"
                style="
                  font-size: 1em;
                  color: #7a5c2e;
                  font-family: 'Just Me Again Down Here', cursive;
                "
                >Location</span
              >
            </div>
          </div>
        </div>
        <div
          id="profile-pins-list"
          style="
            margin-top: 80px;
            margin-left: 2.5em;
            max-width: 900px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5em;
            margin-bottom: 4em;
          "
        ></div>
        <div
          id="pin-modal-overlay"
          style="
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.32);
            align-items: center;
            justify-content: center;
          "
        >
          <div
            id="pin-modal"
            style="
              background: #fffbe7;
              border-radius: 22px;
              box-shadow: 0 4px 32px #7a5c2e33;
              padding: 2.2em 2.5em 2em 2.5em;
              max-width: 420px;
              width: 95vw;
              max-height: 90vh;
              overflow-y: auto;
              position: relative;
              display: flex;
              flex-direction: column;
              align-items: flex-start;
            "
          >
            <button
              id="close-pin-modal"
              style="
                position: absolute;
                top: 1.1em;
                right: 1.1em;
                background: none;
                border: none;
                font-size: 1.7em;
                color: #f89090;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <h3
              id="modal-pin-title"
              style="
                font-family: 'Just Me Again Down Here', cursive;
                font-size: 1.5em;
                color: #f89090;
                margin-bottom: 0.2em;
              "
            ></h3>
            <div
              id="modal-pin-place"
              style="
                font-family: 'Just Me Again Down Here', cursive;
                font-size: 1.1em;
                color: #7a5c2e;
                margin-bottom: 0.7em;
              "
            ></div>
            <div
              id="modal-pin-date"
              style="
                font-family: 'Just Me Again Down Here', cursive;
                font-size: 1em;
                color: #a67c52;
                margin-bottom: 0.7em;
              "
            ></div>
            <div
              id="modal-pin-memory"
              style="
                font-family: 'Just Me Again Down Here', cursive;
                font-size: 1.1em;
                color: #7a5c2e;
                margin-bottom: 1em;
                white-space: pre-line;
              "
            ></div>
            <div
              id="modal-pin-images"
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 0.7em;
                margin-bottom: 0.5em;
                width: 100%;
              "
            ></div>
          </div>
        </div>
      </section>
    </main>
    <footer>
      <a href="index.html">← Back to home</a>
    </footer>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var menuBtn = document.getElementById('sidebar-menu-btn');
        var menuDropdown = document.getElementById('sidebar-menu-dropdown');
        var logoutBtn = document.getElementById('logout-btn');
        if (menuBtn && menuDropdown) {
          menuBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            menuDropdown.style.display =
              menuDropdown.style.display === 'block' ? 'none' : 'block';
          });
          document.addEventListener('click', function (e) {
            if (menuDropdown.style.display === 'block') {
              menuDropdown.style.display = 'none';
            }
          });
        }
        if (logoutBtn && window.firebase && firebase.auth) {
          logoutBtn.addEventListener('click', function () {
            firebase
              .auth()
              .signOut()
              .then(function () {
                window.location.href = 'index.html';
              });
          });
        }
      });
      function renderProfile(user) {
        if (!user) return;
        document.getElementById('profile-name').textContent =
          user.displayName || 'Name';
        document.getElementById('profile-location').textContent =
          user.location || 'Location';
        document.getElementById('profile-about').textContent =
          user.about || 'About you';
        var sidebarName = document.getElementById('sidebar-user-name');
        if (sidebarName)
          sidebarName.textContent = user.displayName || user.email || 'User';

        var profileAvatar = document.getElementById('profile-avatar');
        var sidebarAvatar = document.getElementById('sidebar-user-avatar');
        const seed = encodeURIComponent(
          user.displayName || user.email || 'ava'
        );
        const fallbackUrl = `https://api.dicebear.com/7.x/personas/svg?seed=${seed}`;
        let avatarUrl = user.photoURL || fallbackUrl;

        function setAvatar(imgEl, url) {
          if (!imgEl) return;
          imgEl.onerror = function () {
            imgEl.src = fallbackUrl;
          };
          imgEl.src = url;
        }
        setAvatar(profileAvatar, avatarUrl);
        setAvatar(sidebarAvatar, avatarUrl);
      }
      window.addEventListener('DOMContentLoaded', function () {
        function setUserSidebar(user) {
          const nameSpan = document.getElementById('sidebar-user-name');
          const avatarImg = document.getElementById('sidebar-user-avatar');
          if (user) {
            nameSpan.textContent = user.displayName || user.email || 'User';
            const seed = encodeURIComponent(
              user.displayName || user.email || 'ava'
            );
            const fallbackUrl = `https://api.dicebear.com/7.x/personas/svg?seed=${seed}`;
            let avatarUrl = user.photoURL || fallbackUrl;
            if (avatarImg) {
              avatarImg.onerror = function () {
                avatarImg.src = fallbackUrl;
              };
              avatarImg.src = avatarUrl;
            }
          } else {
            nameSpan.textContent = 'User';
            if (avatarImg)
              avatarImg.src =
                'https://api.dicebear.com/7.x/personas/svg?seed=ava';
          }
        }
        async function renderUserPins(user) {
          const pinsList = document.getElementById('profile-pins-list');
          if (!pinsList) return;
          pinsList.innerHTML =
            '<span style="color:#7a5c2e;font-family:Just Me Again Down Here,cursive;font-size:1.2em;">Loading your pins...</span>';
          try {
            const db = firebase.firestore();
            const pinsSnap = await db
              .collection('pins')
              .where('userId', '==', user.uid) 
              .orderBy('date', 'desc')
              .get();
            console.log('[flashback] Current user.uid:', user.uid);
            console.log('[flashback] Pins found:', pinsSnap.size);
            if (pinsSnap.empty) {
              pinsList.innerHTML =
                '<span style="color:#7a5c2e;font-family:Just Me Again Down Here,cursive;font-size:1.1em;">No pins yet. Drop a pin on the map!</span>';
              return;
            }
            let html = '';
            let pinsArr = [];
            pinsSnap.forEach(doc => {
              const pin = doc.data();
              pin._id = doc.id;
              pinsArr.push(pin);
            });
            pinsArr.forEach(pin => {
              html += `<div class="scrapbook-border pin-card" data-pin-id="${
                pin._id
              }" style="background:#fffbe7;padding:1.2em 1.5em 1.2em 1.2em;border-radius:18px;box-shadow:0 2px 8px #7a5c2e22;display:flex;flex-direction:column;align-items:flex-start;min-width:0;cursor:pointer;">
                <span style="font-family:'Just Me Again Down Here',cursive;font-size:1.15em;color:#f89090;font-weight:bold;word-break:break-word;">${
                  pin.title || 'Untitled Pin'
                }</span>
                <span style="font-family:'Just Me Again Down Here',cursive;font-size:1em;color:#7a5c2e;word-break:break-word;">${
                  pin.place || ''
                }</span>
              </div>`;
            });
            pinsList.innerHTML = html;
            document.querySelectorAll('.pin-card').forEach(card => {
              card.addEventListener('click', async function () {
                const pinId = card.getAttribute('data-pin-id');
                let pin = pinsArr.find(p => p._id === pinId);
                if (!pin) return;
                if (!pin.photoUrls || pin.photoUrls.length === 0) {
                  try {
                    const db = firebase.firestore();
                    const memDoc = await db
                      .collection('memoryPins')
                      .doc(pinId)
                      .get();
                    if (memDoc.exists) {
                      const memData = memDoc.data();
                      if (memData && memData.photoUrls) {
                        pin.photoUrls = memData.photoUrls;
                      }
                    }
                  } catch (e) {}
                }
                document.getElementById('modal-pin-title').textContent =
                  pin.title || 'Untitled Pin';
                document.getElementById('modal-pin-place').textContent =
                  pin.place || '';
                document.getElementById('modal-pin-date').textContent = pin.date
                  ? new Date(pin.date).toLocaleString()
                  : '';
                document.getElementById('modal-pin-memory').textContent =
                  pin.memory || '';
                const imagesDiv = document.getElementById('modal-pin-images');
                imagesDiv.innerHTML = '';
                let urls = [];
                if (Array.isArray(pin.photoUrls) && pin.photoUrls.length > 0) {
                  urls = pin.photoUrls;
                } else if (typeof pin.photoUrls === 'string' && pin.photoUrls) {
                  urls = [pin.photoUrls];
                } else if (Array.isArray(pin.urls) && pin.urls.length > 0) {
                  urls = pin.urls;
                } else if (typeof pin.urls === 'string' && pin.urls) {
                  urls = [pin.urls];
                }
                if (urls.length > 0) {
                  urls.forEach(url => {
                    if (url) {
                      const img = document.createElement('img');
                      img.src = url;
                      img.style.width = '80px';
                      img.style.height = '80px';
                      img.style.objectFit = 'cover';
                      img.style.borderRadius = '10px';
                      img.style.border = '2px solid #f89090';
                      imagesDiv.appendChild(img);
                    }
                  });
                }
                document.getElementById('pin-modal-overlay').style.display =
                  'flex';
              });
            });
            document.getElementById('close-pin-modal').onclick = function () {
              document.getElementById('pin-modal-overlay').style.display =
                'none';
            };
            document.getElementById('pin-modal-overlay').onclick = function (
              e
            ) {
              if (e.target === this) this.style.display = 'none';
            };
          } catch (e) {
            pinsList.innerHTML = `<span style=\"color:#f00;\">Error loading pins: ${e.message}</span>`;
          }
        }
        function checkAuth() {
          if (window.firebase && firebase.auth) {
            firebase.auth().onAuthStateChanged(async function (user) {
              setUserSidebar(user);
              if (!user) return;
              let localProfile = null;
              try {
                localProfile = JSON.parse(
                  localStorage.getItem('flashback_profile')
                );
              } catch (e) {}
              const db = firebase.firestore();
              const userDoc = await db
                .collection('profileInfo')
                .doc(user.uid)
                .get();
              const userData = userDoc.exists ? userDoc.data() : {};
              renderProfile({
                displayName: userData.displayName || user.displayName,
                email: user.email,
                photoURL: userData.photoURL || user.photoURL,
                username: userData.username,
                location: userData.location,
                about: userData.about,
              });
              renderUserPins(user);
            });
          } else {
            setTimeout(checkAuth, 100);
          }
        }
        checkAuth();
      });
    </script>
  </body>
</html>
