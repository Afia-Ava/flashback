<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>flashback – settings</title>
    <link rel="stylesheet" href="map.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Just+Me+Again+Down+Here&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <main class="main-flex">
      <aside class="sidebar scrapbook-border">
        <a
          href="index.html"
          class="flashback-cute"
          style="text-decoration: none; color: #f89090"
          >flashback</a
        >
        <nav class="sidebar-menu" style="margin-top: 1.5em; position: relative">
          <button
            type="button"
            class="sidebar-menu-item"
            onclick="window.location.href='map.html'"
          >
            Map
          </button>
          <button
            type="button"
            class="sidebar-menu-item"
            onclick="window.location.href='drop-pin.html'"
          >
            Drop a Pin
          </button>
          <button
            type="button"
            class="sidebar-menu-item"
            onclick="window.location.href='profile.html'"
          >
            Profile
          </button>
          <button type="button" class="sidebar-menu-item active">
            Settings
          </button>
        </nav>
        <div style="flex: 1"></div>
        <div
          id="sidebar-user-profile"
          style="
            display: flex;
            align-items: center;
            gap: 0.8em;
            padding: 1.2em 1.2em 2.5em 1.2em;
            margin-bottom: 1.5em;
            position: relative;
          "
        >
          <img
            id="sidebar-user-avatar"
            src="https://api.dicebear.com/7.x/personas/svg?seed=ava"
            alt="User Avatar"
            style="
              width: 44px;
              height: 44px;
              border-radius: 50%;
              border: 2.5px solid #f89090;
              background: #fff;
              object-fit: cover;
            "
          />
          <span
            id="sidebar-user-name"
            style="
              font-family: 'Just Me Again Down Here', cursive;
              font-size: 1.3em;
              color: #f89090;
              font-weight: bold;
              margin-right: 0.5em;
            "
            >User</span
          >
          <div style="position: relative; margin-left: auto">
            <button
              id="sidebar-menu-btn"
              style="
                background: none;
                border: none;
                cursor: pointer;
                font-size: 1.5em;
                color: #f89090;
                padding: 0 0.2em;
              "
            >
              &#8942;
            </button>
            <div
              id="sidebar-menu-dropdown"
              style="
                display: none;
                position: absolute;
                right: 0;
                top: 2.2em;
                background: #fff;
                border: 1.5px solid #f89090;
                border-radius: 10px;
                box-shadow: 0 2px 8px #f8909022;
                min-width: 120px;
              "
            >
              <button
                id="logout-btn"
                style="
                  display: block;
                  width: 100%;
                  background: none;
                  border: none;
                  padding: 0.7em 1.2em;
                  text-align: left;
                  color: #f89090;
                  font-family: 'Just Me Again Down Here', cursive;
                  font-size: 1.1em;
                  cursor: pointer;
                "
              >
                Log out
              </button>
            </div>
          </div>
        </div>
      </aside>
      <section class="profile-green-full">
        <div
          style="
            margin: 2.5em 0 0 2.5em;
            display: flex;
            flex-direction: column;
            gap: 1.5em;
            align-items: flex-start;
            max-height: 90vh;
            overflow-y: auto;
            min-width: 340px;
            width: 100%;
          "
        >
          <h2
            style="
              font-family: 'Just Me Again Down Here', cursive;
              font-size: 2.2em;
              color: #f89090;
              margin: 0 0 0.7em 0;
              font-weight: normal;
              letter-spacing: 1px;
              text-align: left;
            "
          >
            Update Profile
          </h2>
          <div
            style="
              display: flex;
              align-items: center;
              gap: 1.2em;
              margin-bottom: 1.2em;
            "
          >
            <div
              style="
                position: relative;
                display: flex;
                align-items: center;
                gap: 1.2em;
              "
            >
              <img
                id="profile-avatar"
                src="https://api.dicebear.com/7.x/personas/svg?seed=ava"
                alt="Profile Picture"
                style="
                  width: 74px;
                  height: 74px;
                  border-radius: 50%;
                  border: 3px solid #4caf50;
                  background: #fff;
                  object-fit: cover;
                "
              />
              <button
                id="choose-avatar-btn"
                type="button"
                style="
                  position: absolute;
                  bottom: 0;
                  right: 0;
                  background: #066920;
                  color: #fff;
                  border-radius: 50%;
                  width: 28px;
                  height: 28px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                  border: 2px solid #fff;
                  font-size: 1.2em;
                  padding: 0;
                  border: 2px solid #fff;
                "
              >
                <span style="font-size: 1.2em">+</span>
              </button>
              <div
                id="avatar-choices"
                style="
                  display: none;
                  position: absolute;
                  top: 80px;
                  left: 0;
                  background: #fffbe7;
                  border: 2px dashed #f89090;
                  border-radius: 14px;
                  box-shadow: 0 2px 8px #f8909022;
                  padding: 1em 1.2em;
                  z-index: 20;
                  gap: 0.7em;
                  flex-wrap: wrap;
                  min-width: 220px;
                "
              >
                <div style="display: flex; gap: 0.7em; flex-wrap: wrap">
                  <img
                    src="avatar/avatar1.jpg"
                    class="avatar-choice"
                    style="
                      width: 48px;
                      height: 48px;
                      border-radius: 50%;
                      border: 2px solid #f89090;
                      cursor: pointer;
                      object-fit: cover;
                    "
                    alt="Avatar 1"
                  />
                  <img
                    src="avatar/avatar2.jpg"
                    class="avatar-choice"
                    style="
                      width: 48px;
                      height: 48px;
                      border-radius: 50%;
                      border: 2px solid #f89090;
                      cursor: pointer;
                      object-fit: cover;
                    "
                    alt="Avatar 2"
                  />
                  <img
                    src="avatar/avatar3.jpg"
                    class="avatar-choice"
                    style="
                      width: 48px;
                      height: 48px;
                      border-radius: 50%;
                      border: 2px solid #f89090;
                      cursor: pointer;
                      object-fit: cover;
                    "
                    alt="Avatar 3"
                  />
                  <img
                    src="avatar/avatar4.jpg"
                    class="avatar-choice"
                    style="
                      width: 48px;
                      height: 48px;
                      border-radius: 50%;
                      border: 2px solid #f89090;
                      cursor: pointer;
                      object-fit: cover;
                    "
                    alt="Avatar 4"
                  />
                  <img
                    src="avatar/avatar5.jpg"
                    class="avatar-choice"
                    style="
                      width: 48px;
                      height: 48px;
                      border-radius: 50%;
                      border: 2px solid #f89090;
                      cursor: pointer;
                      object-fit: cover;
                    "
                    alt="Avatar 5"
                  />
                  <img
                    src="avatar/avatar6.jpg"
                    class="avatar-choice"
                    style="
                      width: 48px;
                      height: 48px;
                      border-radius: 50%;
                      border: 2px solid #f89090;
                      cursor: pointer;
                      object-fit: cover;
                    "
                    alt="Avatar 6"
                  />
                </div>
                <div style="width: 100%; text-align: right; margin-top: 0.5em">
                  <button
                    type="button"
                    id="close-avatar-choices"
                    style="
                      background: none;
                      border: none;
                      color: #f89090;
                      font-size: 1.1em;
                      cursor: pointer;
                      font-family: 'Just Me Again Down Here', cursive;
                    "
                  >
                    close
                  </button>
                </div>
              </div>
            </div>
            <script>
              document.addEventListener('DOMContentLoaded', function () {
                var chooseBtn = document.getElementById('choose-avatar-btn');
                var avatarChoices = document.getElementById('avatar-choices');
                var profileAvatar = document.getElementById('profile-avatar');
                var sidebarAvatar = document.getElementById(
                  'sidebar-user-avatar'
                );
                var closeBtn = document.getElementById('close-avatar-choices');
                if (chooseBtn && avatarChoices) {
                  chooseBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    avatarChoices.style.display =
                      avatarChoices.style.display === 'flex' ? 'none' : 'flex';
                  });
                }
                if (closeBtn && avatarChoices) {
                  closeBtn.addEventListener('click', function () {
                    avatarChoices.style.display = 'none';
                  });
                }
                avatarChoices
                  .querySelectorAll('.avatar-choice')
                  .forEach(function (img) {
                    img.addEventListener('click', function () {
                      var src = img.getAttribute('src');
                      profileAvatar.src = src;
                      if (sidebarAvatar) sidebarAvatar.src = src;
                      localStorage.setItem('flashback_profile_avatar', src);
                      avatarChoices.style.display = 'none';
                    });
                  });
                var savedAvatar = localStorage.getItem(
                  'flashback_profile_avatar'
                );
                if (savedAvatar) {
                  profileAvatar.src = savedAvatar;
                  if (sidebarAvatar) sidebarAvatar.src = savedAvatar;
                } else {
                  if (sidebarAvatar) sidebarAvatar.src = profileAvatar.src;
                }
                if (sidebarAvatar) {
                  var saved = localStorage.getItem('flashback_profile_avatar');
                  if (saved) sidebarAvatar.src = saved;
                }
                document.addEventListener('click', function (e) {
                  if (
                    avatarChoices.style.display === 'flex' &&
                    !avatarChoices.contains(e.target) &&
                    e.target !== chooseBtn
                  ) {
                    avatarChoices.style.display = 'none';
                  }
                });
              });
            </script>
          </div>
          <div
            style="
              display: flex;
              flex-direction: column;
              gap: 1em;
              width: 100%;
              max-width: 420px;
            "
          >
            <label style="font-size: 1.1em; color: #7a5c2e; text-align: left"
              >Name
              <input
                type="text"
                id="profile-name"
                placeholder="Your name"
                style="
                  width: 100%;
                  padding: 0.7em;
                  border-radius: 8px;
                  border: 2px solid #f89090;
                  background: #fde8e8;
                  font-size: 1em;
                  margin-top: 0.3em;
                  text-align: left;
                  font-family: 'Just Me Again Down Here', cursive;
                  color: #7a5c2e;
                "
              />
            </label>
            <label style="font-size: 1.1em; color: #7a5c2e; text-align: left"
              >Email
              <input
                type="text"
                id="profile-email"
                placeholder="Email"
                style="
                  width: 100%;
                  padding: 0.7em;
                  border-radius: 8px;
                  border: 2px solid #f89090;
                  background: #fde8e8;
                  font-size: 1em;
                  margin-top: 0.3em;
                  text-align: left;
                  font-family: 'Just Me Again Down Here', cursive;
                  color: #7a5c2e;
                "
                readonly
              />
            </label>
            <label style="font-size: 1.1em; color: #7a5c2e; text-align: left"
              >About you
              <textarea
                id="profile-about"
                placeholder="About you"
                rows="2"
                style="
                  width: 100%;
                  padding: 0.7em;
                  border-radius: 8px;
                  border: 2px solid #f89090;
                  background: #fde8e8;
                  font-size: 1em;
                  margin-top: 0.3em;
                  resize: vertical;
                  text-align: left;
                  font-family: 'Just Me Again Down Here', cursive;
                  color: #7a5c2e;
                "
              ></textarea>
            </label>
            <label style="font-size: 1.1em; color: #7a5c2e; text-align: left"
              >Location
              <input
                type="text"
                id="profile-location"
                placeholder="Location"
                style="
                  width: 100%;
                  padding: 0.7em;
                  border-radius: 8px;
                  border: 2px solid #f89090;
                  background: #fde8e8;
                  font-size: 1em;
                  margin-top: 0.3em;
                  text-align: left;
                  font-family: 'Just Me Again Down Here', cursive;
                  color: #7a5c2e;
                "
              />
            </label>
          </div>
          <button
            id="save-profile-btn"
            type="button"
            style="
              background: #f89090;
              color: #fff;
              border: none;
              border-radius: 10px;
              padding: 0.9em 2.5em;
              font-size: 1.1em;
              font-family: 'Just Me Again Down Here', cursive;
              font-weight: bold;
              cursor: pointer;
              margin-top: 1.2em;
              margin-bottom: 2.5em;
              align-self: flex-start;
              box-shadow: none;
            "
          >
            Save
          </button>
        </div>
      </section>
    </main>
    <footer>
      <a href="index.html">← Back to home</a>
    </footer>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var menuBtn = document.getElementById('sidebar-menu-btn');
        var menuDropdown = document.getElementById('sidebar-menu-dropdown');
        var logoutBtn = document.getElementById('logout-btn');
        if (menuBtn && menuDropdown) {
          menuBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            menuDropdown.style.display =
              menuDropdown.style.display === 'block' ? 'none' : 'block';
          });
          document.addEventListener('click', function (e) {
            if (menuDropdown.style.display === 'block') {
              menuDropdown.style.display = 'none';
            }
          });
        }
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function () {
            if (window.firebase && firebase.auth) {
              firebase
                .auth()
                .signOut()
                .then(function () {
                  window.location.href = 'index.html';
                });
            } else {
              window.location.href = 'index.html';
            }
          });
        }
      });

      document.addEventListener('DOMContentLoaded', function () {
        var saveBtn = document.getElementById('save-profile-btn');
        if (saveBtn) {
          saveBtn.addEventListener('click', async function () {
            var nameInput = document.getElementById('profile-name');
            var aboutInput = document.getElementById('profile-about');
            var locationInput = document.getElementById('profile-location');
            var name = nameInput.value.trim();
            var about = aboutInput.value.trim();
            var location = locationInput.value.trim();
            var photoURL = document.getElementById('profile-avatar').src;
            if (!window.firebase || !firebase.auth().currentUser) {
              alert('You must be logged in to save your profile.');
              return;
            }
            var uid = firebase.auth().currentUser.uid;
            try {
              var db = window.firebase.firestore();
              await db.collection('profileInfo').doc(uid).set(
                {
                  displayName: name,
                  about: about,
                  location: location,
                  photoURL: photoURL,
                },
                { merge: true }
              );
              nameInput.value = '';
              aboutInput.value = '';
              locationInput.value = '';
              setTimeout(async function () {
                var doc = await db.collection('profileInfo').doc(uid).get();
                if (doc.exists) {
                  var data = doc.data();
                  nameInput.value = data.displayName || '';
                  aboutInput.value = data.about || '';
                  locationInput.value = data.location || '';
                  if (data.photoURL) {
                    document.getElementById('profile-avatar').src =
                      data.photoURL;
                  }
                }
                var user = firebase.auth().currentUser;
                if (user) {
                  document.getElementById('profile-email').value =
                    user.email || '';
                }
              }, 300);
            } catch (e) {
              alert('Error saving profile: ' + e.message);
            }
          });
        }
      });
      function setUserSidebar(user) {
        const nameSpan = document.getElementById('sidebar-user-name');
        const avatarImg = document.getElementById('sidebar-user-avatar');
        if (user) {
          nameSpan.textContent = user.displayName || user.email || 'User';
        } else {
          nameSpan.textContent = 'User';
        }
        var savedAvatar = localStorage.getItem('flashback_profile_avatar');
        if (avatarImg && savedAvatar) {
          avatarImg.src = savedAvatar;
        } else if (avatarImg) {
          avatarImg.src = 'https://api.dicebear.com/7.x/personas/svg?seed=ava';
        }
      }
      window.addEventListener('DOMContentLoaded', function () {
        var sidebarAvatar = document.getElementById('sidebar-user-avatar');
        var savedAvatar = localStorage.getItem('flashback_profile_avatar');
        if (sidebarAvatar && savedAvatar) {
          sidebarAvatar.src = savedAvatar;
        }

        function loadProfileInfo(user) {
          if (!user) return;
          var db = window.firebase.firestore();
          db.collection('profileInfo')
            .doc(user.uid)
            .get()
            .then(function (doc) {
              if (doc.exists) {
                var data = doc.data();
                document.getElementById('profile-name').value =
                  data.displayName || '';
                document.getElementById('profile-about').value =
                  data.about || '';
                document.getElementById('profile-location').value =
                  data.location || '';
                if (data.photoURL) {
                  document.getElementById('profile-avatar').src = data.photoURL;
                  if (sidebarAvatar) sidebarAvatar.src = data.photoURL;
                }
              }

              document.getElementById('profile-email').value = user.email || '';
            });
        }

        function checkAuth() {
          if (window.firebase && firebase.auth) {
            firebase.auth().onAuthStateChanged(function (user) {
              setUserSidebar(user);
              loadProfileInfo(user);
            });
          } else {
            setTimeout(checkAuth, 100);
          }
        }
        checkAuth();
      });
    </script>
  </body>
</html>
